---
title: "National 'Legally Free' Rates"
resource_files:
- StUS_GCS12.dbf
- StUS_GCS12.prj
- StUS_GCS12.sbn
- StUS_GCS12.sbx
- StUS_GCS12.shx
runtime: shiny
output:
  flexdashboard::flex_dashboard: null
  orientation: columns
source_code: embed
theme: flatly
social:
- twitter
- facebook
- menu
vertical_layout: scroll
---
  
  
```{r setup, include=FALSE, message=FALSE}
# Load packages and initialize data here
library(flexdashboard)
library(rgdal)
library(leaflet)
library(ggplot2)
library(scales)
library(magrittr)
library(readr)
library(knitr)
library(shiny)
library(dplyr)
```

```{r}
states <- readOGR("StUS_GCS12.shp",
                  layer = "StUS_GCS12", GDAL1_integer64_policy = TRUE, verbose = FALSE)

dat_legally_free <- read.csv("legally_free_ages.csv")

# creating ref table 

cd_age <- 0:4
tx_age <- c("All", "0-4", "5-9", "10-14", "15-17")
ref_age_groups <- data.frame(cd_age, tx_age)

```


Point-In-Time Rates
=======================================================================

Choose a Year {.sidebar}
-------------------------------------
```{r}
hr()

selectInput("ffy", label = "Federal fiscal year: ",
            choices = 2010:2016, selected = 2016)

selectInput("age_at_start", label = "Age group first day of FFY: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This map shows the point-in-time percentage of legally free children in each state in a federal fiscal year (choose above). The maps are based on [AFCARS](https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars) data obtained from [NDACAN](https://www.ndacan.cornell.edu/). Clicking on a state will display the numerator and denominator data on which the percentages are based. 

Prepared by Partners for Our Children

Map
-------------------------------------
    
###  
    
```{r}
states <- readOGR("StUS_GCS12.shp",
                  layer = "StUS_GCS12", GDAL1_integer64_policy = TRUE, verbose = FALSE)

dat_legally_free <- read.csv("legally_free_ages.csv")

# creating ref table 

cd_age <- 0:4
tx_age <- c("All", "0-4", "5-9", "10-14", "15-17")
ref_age_groups <- data.frame(cd_age, tx_age)

# state specific zipcodes and data
STATE_SHP <- reactive({
  
states@data <- states@data %>%
  inner_join(dat_legally_free, by = c("st_abbrev" = "st")) %>%
  filter(ffy == input$ffy, age_at_start == input$age_at_start) %>%
  left_join(ref_age_groups, by = c("age_at_start" = "cd_age"))

STATE_SHP <- states
  
}) # END OF REACTIVE

# color palette
renderLeaflet({
  
pal <- colorBin(palette = "PuBu", domain = STATE_SHP()$per_leg_free_first_day*100, bins = 8)

state_popup <- paste0("<h3><strong>",
                      scales::percent(STATE_SHP()$per_leg_free_first_day),
                      " Legally Free</strong></h3>",
                      "In the <strong>State of ", 
                      STATE_SHP()$atlas_name,
                      "</strong>, ",
                      "on the first day of federal fiscal year <strong>", 
                      STATE_SHP()$ffy, 
                      "</strong>, ",
                      "there were <strong>",
                      prettyNum(STATE_SHP()$total_kids_in_care_first_day, big.mark = ","),
                      "</strong>",
                      " children", 
                      "<strong>",
                      ifelse(STATE_SHP()$tx_age != 'All', paste0(", ages ", as.character(STATE_SHP()$tx_age), ","), " "),
                      "</strong>",
                      " in foster care. <br><br>According to <a href='https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars'>AFCARS</a> data, <strong>",
                      prettyNum(STATE_SHP()$legally_free_first_day, big.mark = ","),
                      "</strong> of those children",
                      " were legally free."
                      )
# plot the map
leaflet(data = STATE_SHP()) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(fillColor = ~pal(STATE_SHP()$per_leg_free_first_day*100), 
              fillOpacity = 0.7, 
              color = "white",
              opacity = 1,
              # dashArray = '3',
              weight = 2, 
              popup = state_popup) %>%
  addLegend("bottomleft", 
            pal = pal, 
            values = ~STATE_SHP()$per_leg_free_first_day*100,
            title = "% Legally Free",
            opacity = 1)
  
  
})
```

Entries To and Exits From "Legally Free"
=======================================================================    

Choose a Year {.sidebar}
-------------------------------------

```{r}
hr()

selectInput("ffy2", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)

selectInput("age_at_lf", label = "Age group when legally free: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This map at the shows the percentage of children who exit to "legal permanency" from "legally free" status in each state within 1 year. Data are displayed based on the federal fiscal year (FFY) that a child entered "legally free" status. The maps are calculated using [AFCARS](https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars) data obtained from [NDACAN](https://www.ndacan.cornell.edu/). Clicking on a state will display the number of entries to legally free status in that state over the selected FFY (choose above).

Prepared by Partners for Our Children

Map
-------------------------------------

###  

```{r}
states <- readOGR("StUS_GCS12.shp",
                  layer = "StUS_GCS12", GDAL1_integer64_policy = TRUE, verbose = FALSE)

# dat_legally_free <- read.csv("legally_free_ages.csv") 

# state specific zipcodes and data
STATE_SHP2 <- reactive({
  
states@data <- states@data %>%
  inner_join(dat_legally_free, by = c("st_abbrev" = "st")) %>%
  filter(ffy == input$ffy2, age_at_lf == input$age_at_lf) %>%
  left_join(ref_age_groups, by = c("age_at_lf" = "cd_age"))

STATE_SHP2 <- states
  
}) # END OF REACTIVE

# color palette
renderLeaflet({
  
pal <- colorBin(palette = "PuBu", domain = STATE_SHP2()$per_exit_one_year*100, bins = 8)

state_popup <- paste0("<h3><strong>",
                      scales::percent(STATE_SHP2()$per_exit_one_year),
                      " Acheiving Permanency within 1 Year</strong></h3>",
                      "In the <strong>State of ", 
                      STATE_SHP2()$atlas_name,
                      "</strong>, ",
                      "over federal fiscal year <strong>", 
                      STATE_SHP2()$ffy, 
                      "</strong>, ",
                      "there were <strong>", 
                      prettyNum(STATE_SHP2()$became_legally_free, big.mark = ","),
                      "</strong>",
                      " children", 
                      "<strong>",
                      ifelse(STATE_SHP2()$tx_age != 'All', paste0(", ages ", as.character(STATE_SHP2()$tx_age), ","), " "),
                      "</strong>",
                      " who became legally free (i.e. had a TPR against both parents). <br><br>According to <a href='https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars'>AFCARS</a> data, <strong>",
                      scales::percent(STATE_SHP2()$per_exit_one_year),
                      "</strong> of children who entered legally free status in ",
                      "<strong>", 
                      STATE_SHP2()$ffy, 
                      "</strong> ",
                      " acheived legal permanency within 365 days.")
                      
# plot the map
leaflet(data = STATE_SHP2()) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
  addPolygons(fillColor = ~pal(STATE_SHP2()$per_exit_one_year*100), 
              fillOpacity = 0.7, 
              color = "white",
              opacity = 1,
              #dashArray = '3',
              weight = 2, 
              popup = state_popup) %>%
  addLegend("bottomleft", 
            pal = pal, 
            values = ~STATE_SHP2()$per_exit_one_year*100,
            title = "% Exiting w/in 1 yr",
            opacity = 1)
  
  
})
```


Percent of "Legally Free" Children and Length of Stay
=======================================================================  

Choose a Year {.sidebar}
-------------------------------------

```{r}
hr()

selectInput("ffy3", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)


selectInput("age_at_start2", label = "Age group when entering care: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This graph shows the percentage of legally free children exiting to permancy within one year of becoming legally free against the percentage of children in out-of-home care that are legally free. 

Prepared by Partners for Our Children

Graph
-------------------------------------

###  

```{r}

# state specific zipcodes and data
data_input <- reactive({
  
dat_legally_free %>%
  filter(ffy == input$ffy3, age_at_start == input$age_at_start2) %>%
    filter(per_leg_free_first_day != 0)

}) # END OF REACTIVE

renderPlot({

  # data_input() %>%
  # ggvis(x = ~per_exit_one_year, y = ~per_leg_free_first_day) %>%
  # layer_points() %>%
  # add_axis("x", title = "% Exiting within 1 year of being \"legally free\"") %>%
  # add_axis("y", title = "% of children who are legally free") #%>%
  # bind_shiny("plot")
  # add_tooltip(paste(), "click") 

  # plot <- `
    ggplot(data_input(), aes(x = per_exit_one_year, y = per_leg_free_first_day)) +
    geom_point(size = 3, col = "#3B6E8F") +
    geom_smooth(method = "lm") +
    scale_x_continuous(labels = percent) +
    scale_y_continuous(labels = percent) +
    # coord_cartesian(xlim = c(0, max(data_input$per_exit_one_year * 1.15)), ylim = c(0, max(data_input$per_leg_free_first_day * 1.15))) +
    labs(x = "% exiting within a year of becoming legally free", y = "% of legally free children in out-of-home care") +
    theme_classic(base_size = 18)
  
}) 


```

```{r}


```


Next tab
=======================================================================  

High Charts Attempt
=======================================================================  

Choose a Year {.sidebar}
-------------------------------------

```{r}
hr()

selectInput("ffy3", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)


selectInput("age_at_start2", label = "Age group when entering care: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

GGVIS Attempt
=======================================================================  

Graph
-------------------------------------

```{r}

vis <- reactive({
  
# data_input <- dat_legally_free %>%
#   filter(ffy == input$ffy3, age_at_start == input$age_at_start2) %>%
#     filter(per_leg_free_first_day != 0)

  dat_legally_free %>%
  ggvis(x = ~per_exit_one_year, y = ~per_leg_free_first_day) %>%
  layer_points() %>%
  add_axis("x", title = "% Exiting within 1 year of being \"legally free\"") %>%
  add_axis("y", title = "% of children who are legally free")

})

vis %>% bind_shiny("plot1")

```

Glossary
=======================================================================  

**Legally Free** - A child is legally free for adoption if the child has no legal parent, either because the parent has died or because parental rights have been terminated (through relinquishment or involuntary termination) by a court order.  





