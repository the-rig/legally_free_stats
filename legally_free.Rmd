---
title: "Legally Free Rates of U.S. Children in Foster Care"
resource_files:
- StUS_GCS12.dbf
- StUS_GCS12.prj
- StUS_GCS12.sbn
- StUS_GCS12.sbx
- StUS_GCS12.shx
runtime: shiny
output:
  flexdashboard::flex_dashboard: null
  orientation: columns
source_code: embed
theme: flatly
social:
- twitter
- facebook
- menu
vertical_layout: scroll
---
  
  
```{r setup, include=FALSE, message=FALSE}
# Load packages and initialize data here
library(flexdashboard)
library(geojsonio)
library(rgdal)
library(leaflet)
library(ggplot2)
library(ggvis)
library(plotly)
library(dygraphs)
library(htmlwidgets)
library(scales)
library(magrittr)
library(readr)
library(knitr)
library(tibble)
library(shiny)
library(tidyr)
library(dplyr)
```

How many are there?
=======================================================================

Choose a Year {.sidebar}
-------------------------------------
```{r}
hr()

selectInput("ffy", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)

selectInput("age_at_start", label = "Age group first day of FFY: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This map shows the point-in-time percentage of legally free children in each state in a federal fiscal year (choose above). The maps are based on [AFCARS](https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars) data obtained from [NDACAN](https://www.ndacan.cornell.edu/). Clicking on a state will display the numerator and denominator data on which the percentages are based. 

Prepared by Partners for Our Children

Map
-------------------------------------
    
###  
    
```{r}
# load states shape file
states <- geojsonio::geojson_read("http://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_040_00_20m.json",
  what = "sp")

# load legally free data
dat_legally_free <- read.csv("legally_free_ages.csv") %>%
  mutate(stfips = stringr::str_pad(stfips, 2, pad = "0")) # make state code joinable

# create ref table for age
cd_age <- 0:4
tx_age <- c("All", "0-4", "5-9", "10-14", "15-17")
ref_age_groups <- data.frame(cd_age, tx_age)

# reactive to get year and age filtered data
STATE_SHP <- reactive({
  
states@data <- states@data %>%
  inner_join(dat_legally_free, by = c("STATE" = "stfips")) %>%
  filter(ffy == input$ffy, age_at_start == input$age_at_start) %>%
  left_join(ref_age_groups, by = c("age_at_start" = "cd_age"))

STATE_SHP <- states
  
}) # END OF REACTIVE

renderLeaflet({

  # color palette  
  pal <- colorBin(palette = "PuBu", domain = STATE_SHP()$per_leg_free_first_day*100, bins = 8)
  # setting for pop-up
  state_popup <- paste0("<h3><strong>",
                      scales::percent(STATE_SHP()$per_leg_free_first_day),
                      " Legally Free</strong></h3>",
                      "In the <strong>State of ", 
                      STATE_SHP()$NAME,
                      "</strong>, ",
                      "on the first day of federal fiscal year <strong>", 
                      STATE_SHP()$ffy, 
                      "</strong>, ",
                      "there were <strong>",
                      prettyNum(STATE_SHP()$total_kids_in_care_first_day, big.mark = ","),
                      "</strong>",
                      " children", 
                      "<strong>",
                      ifelse(STATE_SHP()$tx_age != 'All', paste0(", ages ", as.character(STATE_SHP()$tx_age), ","), " "),
                      "</strong>",
                      " in foster care. <br><br>According to <a href='https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars'>AFCARS</a> data, <strong>",
                      prettyNum(STATE_SHP()$legally_free_first_day, big.mark = ","),
                      "</strong> of those children",
                      " were legally free."
                      )
  
  # plot the map
  leaflet(data = STATE_SHP()) %>%
    addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
    addPolygons(fillColor = ~pal(STATE_SHP()$per_leg_free_first_day*100), 
                fillOpacity = 0.7, 
                color = "white",
                opacity = 1,
                weight = 2, 
                popup = state_popup) %>%
    addLegend("bottomleft", 
              pal = pal, 
              values = ~STATE_SHP()$per_leg_free_first_day*100,
              title = "% Legally free",
              opacity = 1)
  })

```

How quickly do they exit from care?
=======================================================================    

Choose filters {.sidebar}
-------------------------------------

```{r}
hr()

selectInput("ffy2", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)

selectInput("age_at_lf", label = "Age group when legally free: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This map at the shows the percentage of children who exit to "legal permanency" from "legally free" status in each state within 1 year. Data are displayed based on the federal fiscal year (FFY) that a child entered "legally free" status. The maps are calculated using [AFCARS](https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars) data obtained from [NDACAN](https://www.ndacan.cornell.edu/). Clicking on a state will display the number of entries to legally free status in that state over the selected FFY (choose above).

Prepared by Partners for Our Children

Map
-------------------------------------

###  

```{r}
states <- geojsonio::geojson_read("http://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_040_00_20m.json",
  what = "sp")

STATE_SHP2 <- reactive({
  
states@data <- states@data %>%
  inner_join(dat_legally_free, by = c("STATE" = "stfips")) %>%
  filter(ffy == input$ffy2, age_at_lf == input$age_at_lf) %>%
  left_join(ref_age_groups, by = c("age_at_lf" = "cd_age"))

STATE_SHP2 <- states
  
}) # END OF REACTIVE

renderLeaflet({
  
  pal <- colorBin(palette = "PuBu", domain = STATE_SHP2()$per_exit_one_year*100, bins = 8)
  
  state_popup <- paste0("<h3><strong>",
                      scales::percent(STATE_SHP2()$per_exit_one_year),
                      " Acheiving Permanency within 1 Year</strong></h3>",
                      "In the <strong>State of ", 
                      STATE_SHP2()$atlas_name,
                      "</strong>, ",
                      "over federal fiscal year <strong>", 
                      STATE_SHP2()$ffy, 
                      "</strong>, ",
                      "there were <strong>", 
                      prettyNum(STATE_SHP2()$became_legally_free, big.mark = ","),
                      "</strong>",
                      " children", 
                      "<strong>",
                      ifelse(STATE_SHP2()$tx_age != 'All', paste0(", ages ", as.character(STATE_SHP2()$tx_age), ","), " "),
                      "</strong>",
                      " who became legally free (i.e. had a TPR against both parents). <br><br>According to <a href='https://www.acf.hhs.gov/cb/research-data-technology/reporting-systems/afcars'>AFCARS</a> data, <strong>",
                      scales::percent(STATE_SHP2()$per_exit_one_year),
                      "</strong> of children who entered legally free status in ",
                      "<strong>", 
                      STATE_SHP2()$ffy, 
                      "</strong> ",
                      " acheived legal permanency within 365 days.")
                      
# plot the map
  
  leaflet(data = STATE_SHP2()) %>%
    addProviderTiles(providers$Esri.WorldGrayCanvas) %>% 
    addPolygons(fillColor = ~pal(STATE_SHP2()$per_exit_one_year*100), 
              fillOpacity = 0.7, 
              color = "white",
              opacity = 1,
              weight = 2, 
              popup = state_popup) %>%
    addLegend("bottomleft", 
            pal = pal, 
            values = ~STATE_SHP2()$per_exit_one_year*100,
            title = "% Exiting in one year",
            opacity = 1)
  
  
})
```


What is the relationship?
=======================================================================  

Choose filters {.sidebar}
-------------------------------------

```{r}
hr()

selectInput("ffy3", label = "Federal fiscal year: ",
            choices = 2010:2015, selected = 2015)


selectInput("age_at_start2", label = "Age group when entering care: "
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = 0)

```

This graph shows the percentage of legally free children exiting to permancy within one year of becoming legally free against the percentage of children in out-of-home care that are legally free. 

Prepared by Partners for Our Children

Graph
-------------------------------------

###  

```{r}

data_input <- reactive({
  
  dat_legally_free %>%
    filter(ffy == input$ffy3, age_at_start == input$age_at_start2) %>%
    filter(per_leg_free_first_day != 0) %>%
    mutate(`Percent legally free` = round(per_leg_free_first_day*100, 2),
            `Percent exiting in one year` = round(per_exit_one_year*100, 2),
            State = st) 

}) # END OF REACTIVE

renderPlotly({

    gg_plot <- ggplot(data_input(), aes(x = `Percent exiting in one year`, y = `Percent legally free`)) +
      geom_point(size = 2, aes(color = State)#col = "#3B6E8F"
                   ) +
      geom_smooth(method = "lm") +
      #scale_x_continuous(labels = percent) +
      #scale_y_continuous(labels = percent) +
      # coord_cartesian(xlim = c(0, max(data_input$per_exit_one_year * 1.15)), ylim = c(0, max(data_input$per_leg_free_first_day * 1.15))) +
      scale_color_discrete(guide = FALSE) +
      labs(x = "% exiting within one year of becoming legally free", y = "% of legally free children in out-of-home care") +
      theme_classic(base_size = 14)
    
    ggplotly(gg_plot, tooltip = c("State", "`Percent legally free`", "`Percent exiting in one year`")
             )
  
}) 

```


Are trends changing?
=======================================================================  
Choose an Age {.sidebar}
-------------------------------------

```{r}
hr()

dat_legally_free_long <- dat_legally_free %>%
  gather(legally_free, percent, c(per_leg_free_first_day, per_exit_one_year)) %>%
  mutate(Percent = round(percent*100, 2),
         State = st)

selectInput("age", label = "Age group:"
            , choices = c("All" = 0, "0-4" = 1, "5-9" = 2, "10-14" = 3, "15-17" = 4)
            , selected = "All")

selectInput("legally_free",
            label = "% Legally free",
            choices = c("In out-of-home care" = "per_leg_free_first_day",
                        "Exiting in one year" = "per_exit_one_year"),
            selected = "In out-of-home care")

sliderInput("percent_slide3",
            label = "Select a % to search above:",
            min = 0,
            max = 1,
            value = 0)

```

Graph
-------------------------------------

### 

```{r}

data_input2 <- reactive({
  
  if(input$legally_free == "per_leg_free_first_day") {
    
    age_data <- dat_legally_free_long %>%
      filter(age_at_start == input$age)
  } else {
    age_data <- dat_legally_free_long %>%
      filter(age_at_lf == input$age)
  }
  
  filtered_data <- age_data %>%
    filter(legally_free == input$legally_free,
           ffy != 2016
           ) %>%
    group_by(st) %>%
    filter(any(percent >= input$percent_slide3
               )) %>%
    ungroup() 
  
  shiny::validate(
    need(input$percent_slide3 <= max(filtered_data$percent, na.rm = TRUE),
    "There are no data points above your selected percent.")
    )
  
  filtered_data
  
})

y_label <- reactive({
  if(input$legally_free == "per_leg_free_first_day") {
    "% of legally free children in out-of-home care"
  } else {
    "% exiting within one year of becoming legally free"
  }
})

renderPlotly({ 
#renderPlot({  
  gg_plot2 <- ggplot(data_input2(), 
    aes(x = ffy, y = Percent, color = State)) +
    geom_line(#aes(alpha = alpha_vector)
              ) +
    scale_x_continuous(breaks = c(2010:2015)) +
    #scale_y_continuous(labels = percent) +
    #scale_colour_hue(l = 50, c = 100) +
    labs(x = "federal fiscal year", y = y_label()) +
    theme_classic(base_size = 14)
  
  ggplotly(gg_plot2, tooltip = c("State", "Percent")
           )
  
})
```

Glossary
=======================================================================  

**Legally Free** - A child is legally free for adoption if the child has no legal parent, either because the parent has died or because parental rights have been terminated (through relinquishment or involuntary termination) by a court order.  





